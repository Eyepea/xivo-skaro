/*
 * XiVO Web-Interface
 * Copyright (C) 2006-2011  Proformatique <technique@proformatique.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var xivo_wz_fm_dbconfig_backend_elt = {
	'error-dbconfig-sqlite-xivo' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-sqlite-xivodb' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-sqlite-xivodb' : {
		'property' : {
			disabled : true
		}
	},
	'error-dbconfig-sqlite-ipbx' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-sqlite-ipbxdb' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-sqlite-ipbxdb' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-host' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-host' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-port' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-port' : {
		'property' : {
			disabled : true
		}
	},
	'error-dbconfig-mysql-xivo' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-mysql-xivodbname' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-xivodbname' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-xivouser' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-xivouser' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-xivopass' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-xivopass' : {
		'property' : {
			disabled : true
		}
	},
	'error-dbconfig-mysql-ipbx' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-mysql-ipbxdbname' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-ipbxdbname' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-ipbxuser' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-ipbxuser' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-mysql-ipbxpass' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-mysql-ipbxpass' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-host' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-host' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-port' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-port' : {
		'property' : {
			disabled : true
		}
	},
	'error-dbconfig-postgresql-xivo' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-postgresql-xivodbname' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-xivodbname' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-xivouser' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-xivouser' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-xivopass' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-xivopass' : {
		'property' : {
			disabled : true
		}
	},
	'error-dbconfig-postgresql-ipbx' : {
		'style' : {
			display : 'none'
		}
	},
	'fd-dbconfig-postgresql-ipbxdbname' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-ipbxdbname' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-ipbxuser' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-ipbxuser' : {
		'property' : {
			disabled : true
		}
	},
	'fd-dbconfig-postgresql-ipbxpass' : {
		'style' : {
			display : 'none'
		}
	},
	'it-dbconfig-postgresql-ipbxpass' : {
		'property' : {
			disabled : true
		}
	},
	'links' : {
		link : [ [ 'error-dbconfig-sqlite-xivo', 0, 1 ],
				[ 'fd-dbconfig-sqlite-xivodb', 0, 1 ],
				[ 'it-dbconfig-sqlite-xivodb', 0, 1 ],
				[ 'error-dbconfig-sqlite-ipbx', 0, 1 ],
				[ 'fd-dbconfig-sqlite-ipbxdb', 0, 1 ],
				[ 'it-dbconfig-sqlite-ipbxdb', 0, 1 ],
				[ 'fd-dbconfig-sqlite-qldb', 0, 1 ],
				[ 'it-dbconfig-sqlite-qldb', 0, 1 ],
				[ 'fd-dbconfig-mysql-host', 0, 1 ],
				[ 'it-dbconfig-mysql-host', 0, 1 ],
				[ 'fd-dbconfig-mysql-port', 0, 1 ],
				[ 'it-dbconfig-mysql-port', 0, 1 ],
				[ 'error-dbconfig-mysql-xivo', 0, 1 ],
				[ 'fd-dbconfig-mysql-xivodbname', 0, 1 ],
				[ 'it-dbconfig-mysql-xivodbname', 0, 1 ],
				[ 'fd-dbconfig-mysql-xivouser', 0, 1 ],
				[ 'it-dbconfig-mysql-xivouser', 0, 1 ],
				[ 'fd-dbconfig-mysql-xivopass', 0, 1 ],
				[ 'it-dbconfig-mysql-xivopass', 0, 1 ],
				[ 'error-dbconfig-mysql-ipbx', 0, 1 ],
				[ 'fd-dbconfig-mysql-ipbxdbname', 0, 1 ],
				[ 'it-dbconfig-mysql-ipbxdbname', 0, 1 ],
				[ 'fd-dbconfig-mysql-ipbxuser', 0, 1 ],
				[ 'it-dbconfig-mysql-ipbxuser', 0, 1 ],
				[ 'fd-dbconfig-mysql-ipbxpass', 0, 1 ],
				[ 'it-dbconfig-mysql-ipbxpass', 0, 1 ],
				[ 'fd-dbconfig-postgresql-host', 0, 1 ],
				[ 'it-dbconfig-postgresql-host', 0, 1 ],
				[ 'fd-dbconfig-postgresql-port', 0, 1 ],
				[ 'it-dbconfig-postgresql-port', 0, 1 ],
				[ 'error-dbconfig-postgresql-xivo', 0, 1 ],
				[ 'fd-dbconfig-postgresql-xivodbname', 0, 1 ],
				[ 'it-dbconfig-postgresql-xivodbname', 0, 1 ],
				[ 'fd-dbconfig-postgresql-xivouser', 0, 1 ],
				[ 'it-dbconfig-postgresql-xivouser', 0, 1 ],
				[ 'fd-dbconfig-postgresql-xivopass', 0, 1 ],
				[ 'it-dbconfig-postgresql-xivopass', 0, 1 ],
				[ 'error-dbconfig-postgresql-ipbx', 0, 1 ],
				[ 'fd-dbconfig-postgresql-ipbxdbname', 0, 1 ],
				[ 'it-dbconfig-postgresql-ipbxdbname', 0, 1 ],
				[ 'fd-dbconfig-postgresql-ipbxuser', 0, 1 ],
				[ 'it-dbconfig-postgresql-ipbxuser', 0, 1 ],
				[ 'fd-dbconfig-postgresql-ipbxpass', 0, 1 ],
				[ 'it-dbconfig-postgresql-ipbxpass', 0, 1 ] ]
	}
};

var xivo_wz_fm_dbconfig_backend = {
	'sqlite' : dwho_clone(xivo_wz_fm_dbconfig_backend_elt)
};
xivo_wz_fm_dbconfig_backend['sqlite']['error-dbconfig-sqlite-xivo']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['sqlite']['fd-dbconfig-sqlite-xivodb']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['sqlite']['it-dbconfig-sqlite-xivodb']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['sqlite']['error-dbconfig-sqlite-ipbx']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['sqlite']['fd-dbconfig-sqlite-ipbxdb']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['sqlite']['it-dbconfig-sqlite-ipbxdb']['property'] = {
	disabled : false
};

xivo_attrib_register('fm_dbconfig_backend-sqlite',
		xivo_wz_fm_dbconfig_backend['sqlite']);

xivo_wz_fm_dbconfig_backend['mysql'] = dwho_clone(xivo_wz_fm_dbconfig_backend_elt);
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-host']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-host']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-port']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-port']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['error-dbconfig-mysql-xivo']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-xivodbname']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-xivodbname']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-xivouser']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-xivouser']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-xivopass']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-xivopass']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['error-dbconfig-mysql-ipbx']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-ipbxdbname']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-ipbxdbname']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-ipbxuser']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-ipbxuser']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['mysql']['fd-dbconfig-mysql-ipbxpass']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['mysql']['it-dbconfig-mysql-ipbxpass']['property'] = {
	disabled : false
};

xivo_attrib_register('fm_dbconfig_backend-mysql',
		xivo_wz_fm_dbconfig_backend['mysql']);

xivo_wz_fm_dbconfig_backend['postgresql'] = dwho_clone(xivo_wz_fm_dbconfig_backend_elt);
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-host']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-host']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-port']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-port']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['error-dbconfig-postgresql-xivo']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-xivodbname']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-xivodbname']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-xivouser']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-xivouser']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-xivopass']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-xivopass']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['error-dbconfig-postgresql-ipbx']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-ipbxdbname']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-ipbxdbname']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-ipbxuser']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-ipbxuser']['property'] = {
	disabled : false
};
xivo_wz_fm_dbconfig_backend['postgresql']['fd-dbconfig-postgresql-ipbxpass']['style'] = {
	display : 'block'
};
xivo_wz_fm_dbconfig_backend['postgresql']['it-dbconfig-postgresql-ipbxpass']['property'] = {
	disabled : false
};

xivo_attrib_register('fm_dbconfig_backend-postgresql',
		xivo_wz_fm_dbconfig_backend['postgresql']);

function xivo_wizard_chg_dbconfig_backend() {
	if ((backend = dwho_eid('it-dbconfig-backend')) !== false)
		xivo_chg_attrib('fm_dbconfig_backend-' + backend.value, 'links', 0, 1);
	xivo_wizard_chg_dbconfig_backend_create_mode();
}

function xivo_wizard_chg_ipbxbackend() {
	if ((backend = dwho_eid('it-ipbxengine')) === false
			|| backend.type !== 'select-one')
		return (false);

	var len = backend.options.length;

	for ( var i = 0; i < len; i++) {
		if ((engine = dwho_eid('ipbxengine-' + backend.options[i].value)) === false)
			continue;
		else if (backend.options[i].value !== backend.value)
			engine.style.display = 'none';
		else
			engine.style.display = 'block';
	}
}

function xivo_wizard_ipbximportuser_error(sum) {
	var spansum = dwho.dom.create_element('span', {
		'id' : 'ipbximportuser-tooltips-error',
		'className' : 'fm-txt-error'
	}, sum);

	dwho.dom.create_focus_caption(dwho_eid('tooltips'),
			dwho_eid('ipbximportuser-lines-status'), spansum, 'center');
}

function xivo_wizard_chg_dbconfig_backend_create_mode() {
	if ($('#it-dbconfig-create_auto:checked').val() !== undefined) {
		$('#sb-part_dbconfig_' + backend.value).hide('slow');
	} else {
		$('#sb-part_dbconfig_' + backend.value).show('slow');
	}
}

function xivo_wizard_chg_entity_name() {
	if (dwho_eid('it-entity-name') === false
			|| dwho_eid('it-entity-displayname') === false)
		return (false);

	var name = '';
	var displayname = dwho_eid('it-entity-displayname').value;

	if (dwho_is_undef(displayname) === false && displayname.length > 0)
		name = displayname;

	name = name.toLowerCase();
	name = name.replace(/[^a-z0-9_\.-]+/g, '');

	dwho_eid('it-entity-name').value = name;
}

function xivo_wizard_dbconfig_backend_onload() {
	dwho.dom.add_event('change', dwho_eid('it-language'), function() {
		this.form['refresh'].value = 1;
		this.form.submit();
	});

	xivo_wizard_chg_ipbxbackend();

	dwho.dom.add_event('change', dwho_eid('it-ipbxengine'),
			xivo_wizard_chg_ipbxbackend);

	xivo_wizard_chg_dbconfig_backend();

	dwho.dom.add_event('change', dwho_eid('it-dbconfig-backend'),
			xivo_wizard_chg_dbconfig_backend);

	xivo_wizard_chg_entity_name();

	dwho.dom.add_event('change', dwho_eid('it-entity-displayname'),
			xivo_wizard_chg_entity_name);

	xivo_wizard_chg_dbconfig_backend_create_mode();

	dwho.dom.add_event('click', dwho_eid('it-dbconfig-create_auto'),
			xivo_wizard_chg_dbconfig_backend_create_mode);

	dwho.dom.add_event('click', dwho_eid('it-previous'), function() {
		this.type = 'submit';
	});

}

dwho.dom.set_onload(xivo_wizard_dbconfig_backend_onload);

var apply_wizard = {

	counter : new Number(1),
	next : '',
	lang : 'en',

	init : function(lang) {
		$('#boxee').show();

		apply_wizard.lang = lang;
		apply_wizard.request_post(undefined,false,lang);
	},

	request_post : function(step,async,lang) {
		if (async === undefined)
			async = false;
		var me = apply_wizard;
		$.ajax({
			type: 'GET',
			url : '/xivo/wizard/ui.php/wizard?step=' + step + '&hl=' + lang,
			async : async,
			success: function(data) {
				var str = data.split('::');
				if (str.length < 2) {
					me.populate_infos('fatal error',true);
				} else if (str[0] == 'next') {
					me.next = str[1];
					me.populate_infos(str[2]);
				} else if (str[0] == 'uri') {
					me.populate_infos(str[2], true);
					me.send_redirect(str[1]);
				} else if (str[0] == 'nexturi') {
					me.next = str[1];
					me.populate_infos(str[3],'async');
					me.send_redirect(str[2]);
				} else if (str[0] == 'redirecturi') {
					me.next = str[1];
					me.populate_infos('',true);
					me.send_redirect(str[2],str[3]);
				} else {
					me.populate_infos('fatal error',true);
				}
			}
		});
		me.counter++;
	},

	populate_infos : function(msg, last) {
		$('#boxee').find('div').append(msg + '<br>');
		if (last === 'async')
			apply_wizard.request_post(apply_wizard.next,true,apply_wizard.lang);
		else if (last === undefined)
			apply_wizard.request_post(apply_wizard.next,false,apply_wizard.lang);
	},

	send_redirect : function(url,timeredirect) {
		if (timeredirect == undefined)
			timeredirect = 10000;
		window.setTimeout(function() {
			window.location = url;
		}, timeredirect);
	}
};

$(function() {
	$('input[name="validate"]').click(function() {
		apply_wizard.init(dwho_i18n_lang);
		return false;
	});
});

Adding agent in conversation counter in QueueSummary AMI event (based on AST_DEVICE_INUSE flag)
Index: asterisk-1.8.15.0/apps/app_queue.c
===================================================================
--- asterisk-1.8.15.0.orig/apps/app_queue.c
+++ asterisk-1.8.15.0/apps/app_queue.c
@@ -7192,6 +7192,7 @@ static int manager_queues_summary(struct
 {
 	time_t now;
 	int qmemcount = 0;
+	int qmembusy= 0;
 	int qmemavail = 0;
 	int qchancount = 0;
 	int qlongestholdtime = 0;
@@ -7216,6 +7217,7 @@ static int manager_queues_summary(struct
 		if (ast_strlen_zero(queuefilter) || !strcmp(q->name, queuefilter)) {
 			/* Reset the necessary local variables if no queuefilter is set*/
 			qmemcount = 0;
+			qmembusy= 0;
 			qmemavail = 0;
 			qchancount = 0;
 			qlongestholdtime = 0;
@@ -7229,6 +7231,9 @@ static int manager_queues_summary(struct
 						++qmemavail;
 					}
 				}
+				if (mem->status == AST_DEVICE_BUSY) {
+					++qmembusy;
+				}
 				ao2_ref(mem, -1);
 			}
 			ao2_iterator_destroy(&mem_iter);
@@ -7242,13 +7247,14 @@ static int manager_queues_summary(struct
 				"Queue: %s\r\n"
 				"LoggedIn: %d\r\n"
 				"Available: %d\r\n"
+				"Talking: %d\r\n"
 				"Callers: %d\r\n" 
 				"HoldTime: %d\r\n"
 				"TalkTime: %d\r\n"
 				"LongestHoldTime: %d\r\n"
 				"%s"
 				"\r\n",
-				q->name, qmemcount, qmemavail, qchancount, q->holdtime, q->talktime, qlongestholdtime, idText);
+				q->name, qmemcount, qmemavail, qmembusy, qchancount, q->holdtime, q->talktime, qlongestholdtime, idText);
 		}
 		ao2_unlock(q);
 		queue_t_unref(q, "Done with iterator");
